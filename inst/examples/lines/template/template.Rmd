<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <title>{{ opts$params$title }}</title>

    {{ get_external(opts) }}

  </head>

  <body>
    <script type="text/javascript">
    ```{r engine="coffee", results="asis", echo = FALSE }

    data = {{ get_data_as_json(opts) }}

    decimal_format = d3.format(".2f")

    color_scale = {{ get_d3_color_scale(opts) }}

    plot = append_plot(
        width: {{ opts$params$width }}
        height: {{ opts$params$height }}
        padding: {{ get_padding_param(opts) }}
        title: "{{ opts$params$title }}"
        xlab: "{{ opts$params$xlab }}"
        ylab: "{{ opts$params$ylab }}"
    )

    plot.scales.x = {{ get_d3_x_scale(opts) }}
    plot.scales.x = add_scale_padding(plot.scales.x)
    draw_x_axis(plot, {{ get_x_tick_values(opts) }})
    draw_x_axis_label(plot)

    plot.scales.y = {{ get_d3_y_scale(opts) }}
    plot.scales.y = add_scale_padding(plot.scales.y)
    draw_y_axis(plot)
    draw_y_axis_label(plot)

    line = d3.svg.line()
        .defined((d) -> !isNaN(d.y)) # skip null and NaN values
        .interpolate("{{ opts$params$interpolate }}")
        .x((d) -> plot.scales.x(d.x))
        .y((d) -> plot.scales.y(d.y))


    g_line = plot.selectAll(".line")
        .data(data)
      .enter().append("g")
        .attr("class", ".line")

    g_line.append("path")
        .attr(
            "class": "line"
            "d": (d) -> line(d.values)
        ).style(
            "stroke": (d) -> color_scale(d.colorize)
            "stroke-width": "{{ opts$params$lwd }}px"
            "fill": "none"
            "shape-rendering": "auto"
        )

    names = g_line.append("text")
        .datum((d) ->
            "line_name": d.line_name
            "value": d.values[d.values.length - 1]
            "colorize": d.colorize
        ).text((d) -> d.line_name)
        .attr(
            "transform": (d) -> "translate(#{plot.scales.x(d.value.x)} #{plot.scales.y(d.value.y)})"
            "dx": 8
            "dy": ".35em"
        ).style(
            "fill": (d) -> color_scale(d.colorize)
            "font-size": "22px"
        )

    # plot.append("defs").append("clipPath")
    #     .attr("id", "clip")
    #   .append("rect")
    #     .attr("width", plot.width)
    #     .attr("height", plot.height);

    # clip = plot.append("g").attr("clip-path", "url(#clip)")

    # transform = (d) ->
    #     "translate(#{plot.scales.x(d.x)},#{plot.scales.y(d.y)})"

    # clip.append("rect")
    #   .attr(
    #         "class": "overlay"
    #         "width":  plot.width
    #         "height": plot.height
    #         "fill": "none"
    #         "pointer-events": "all"
    #   ).style("cursor","move")
    #   .call(d3.behavior.zoom()
    #       .x(plot.scales.x)
    #       .y(plot.scales.y)
    #       .scaleExtent([1, Infinity])
    #       .on("zoom", () -> redraw() )
    #   )

    # redraw = () ->
    #     plot.select(".x.axis").call(plot.axes.x);
    #     plot.select(".y.axis").call(plot.axes.y);
    #     circles.attr("transform", transform)
    #     names.attr("transform", transform)

    # $(".circle_tooltip").tooltip
    #     html: true
    #     container: "body"
    #     placement: "top"

    sidebar = plot.append("g")
        .attr("transform","translate(#{plot.width + 20},#{0})")

    g_names = sidebar.append("g")
        .style("cursor", "pointer")
        .style("font-size","22px")
        .on("click", () -> toggle_names() )

    g_names.append("circle")
        .attr("r", 7)
        .attr("stroke","black")
        .attr("stroke-width",2)

    g_names.append("text")
        .attr('text-anchor', 'start')
        .attr('dy', '.32em')
        .attr('dx', '12')


    toggle_names = ()->
        if g_names.classed("show_names")
            g_names.attr("class","")
            toggle_g_names()
        else
            g_names.attr("class","show_names")
            toggle_g_names()

    toggle_g_names = ()->
        if g_names.classed("show_names")
            names.attr("display", "inline")
            g_names.select("circle").attr("fill","black")
            # g_names.select("text").text(" Hide names")
        else
            names.attr("display", "none")
            g_names.select("circle").attr("fill","white")
            g_names.select("text").text("Show names")

    toggle_g_names()

    if color_scale.range().length > 1
        g_color_legend = sidebar.selectAll(".key")
            .data(color_scale.domain().reverse())
          .enter().append("g")
            .attr(
                  "transform": (d, i) -> "translate(0, #{i * (5 * 2 + 15) + 50})"
                  "class": "key"
            )

        g_color_legend.append("circle")
            .attr(
                "r": 5
                "fill": color_scale
            )

        # legend_names = get_legend_names_param(opts)
        g_color_legend.append("text")
            .attr(
                "x": 20 + 10
                "y": 0
                "dy": ".35em"
            ).text((d) -> d)
            # ).text((d,i) -> legend_names[i])

    # d3.select(window).on("keydown", () ->
    #     # switch (d3.event.keyCode) {
    #       # case : year = Math.max(year0, year - 10); break;
    #       # case 39: year = Math.min(year1, year + 10); break;
    #     # }
    #     # console.log(d3.event.keyCode)
    #     if (d3.event.keyCode in [78, 32]) # 'n' or 'space bar'
    #         change()
    # )

    ```
    </script>
  </body>
</html>